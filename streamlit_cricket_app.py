<FULL UPDATED CODE FROM PREVIOUS ANSWER>